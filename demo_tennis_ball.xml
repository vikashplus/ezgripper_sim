<?xml version="1.0"?>
<mujoco model="ezgripper_tennis_ball_demo">
<!-- =================================================
    EZGripper Tennis Ball Grasp Demo
    Demonstrates under-actuated grasping behavior:
    - L1 contacts ball first and stops
    - Tendon force overcomes L2 spring
    - L2 wraps around ball
    - Adaptive conforming to spherical object
====================================================== -->
    <compiler angle="radian" settotalmass=".340"/>
    <size njmax="500" nconmax="100" />
    
    <option timestep="0.002" gravity="0 0 -9.81">
        <flag warmstart="enable"/>
    </option>
    
    <visual>
        <headlight ambient="0.5 0.5 0.5" diffuse="0.8 0.8 0.8" specular="0.3 0.3 0.3"/>
        <rgba haze="0.15 0.25 0.35 1"/>
        <quality shadowsize="4096"/>
        <map shadowclip="1.0" znear="0.01" zfar="50"/>
    </visual>
    
    <asset>
        <mesh name="SAKE_Single_Mount" file="meshes/SAKE_Single_Mount.stl" />
        <mesh name="SAKE_Palm_IM" file="meshes/SAKE_Palm_IM.stl" />
        <mesh name="SAKE_Finger_L1_IM" file="meshes/SAKE_Finger_L1_IM.stl" />
        <mesh name="SAKE_Finger_L2_IM" file="meshes/SAKE_Finger_L2_IM.stl" />
        <mesh name="SAKE_Finger_Pad_IM" file="meshes/SAKE_Finger_Pad_IM.stl" />
        
        <texture name="grid" type="2d" builtin="checker" width="512" height="512" 
                 rgb1=".1 .2 .3" rgb2=".2 .3 .4"/>
        <material name="grid" texture="grid" texrepeat="1 1" texuniform="true" reflectance=".2"/>
    </asset>

    <default>
        <default class="ezgripper">
            <joint damping="0.005" limited="true"/>
            <geom contype="1" conaffinity="1" group="4" type="mesh" rgba=".5 .6 .7 1"/>
            <default class="ezgripper_viz">
                <geom contype="0" conaffinity="0" group="1" type="mesh" rgba=".17 .42 .63 1"/>
            </default>
            <default class="ezgripper_mech">
                <geom contype="0" conaffinity="0" group="1" type="cylinder" rgba="1 0 0 1"/>
                <site rgba="1 0 0 1"/>
            </default>
        </default>
    </default>

    <contact>
        <pair geom1="f1_tip" geom2="f2_tip" condim="1"/>
        <pair geom1="f1_tip" geom2="f2l1" condim="1"/>
        <pair geom1="f2_tip" geom2="f1l1" condim="1"/>
        <pair geom1="f1_l1_contact" geom2="f1_l2_contact" margin="0.00005" solref="0.0005 1"/>
        <pair geom1="f2_l1_contact" geom2="f2_l2_contact" margin="0.00005" solref="0.0005 1"/>
    </contact>

    <worldbody>
        <!-- Ground plane -->
        <geom name='floor' pos='0 0 0' size='.4 .4 .125' type='plane' material="grid" condim='3'/>
        
        <!-- Lighting -->
        <light directional='false' diffuse='.8 .8 .8' specular='0.3 0.3 0.3' pos='0 0 1.0' dir='0 0 -1'/>
        <light directional='false' diffuse='.5 .5 .5' specular='0.2 0.2 0.2' pos='0.3 0.3 0.5' dir='-1 -1 -1'/>
        
        <!-- Tennis Ball (2.5" diameter = 0.0635m radius = 0.03175m) -->
        <!-- Official tennis ball: 56.0-59.4g, using 58g -->
        <!-- Centered in gripper XY plane -->
        <body name="tennis_ball" pos="0.19 0 0.03175">
            <freejoint/>
            <geom name="ball" type="sphere" size="0.03175" 
                  rgba="0.8 0.9 0.2 1" mass="0.058" friction="1.0 0.005 0.0001"/>
            <site name="ball_center" pos="0 0 0" size="0.005" rgba="1 0 0 0.5"/>
        </body>

        <!-- PALM - EZGripper positioned above ball -->
        <body name="mount" pos="0.19 0 0.15" childclass="ezgripper">
            <geom class="ezgripper_viz" mesh="SAKE_Single_Mount" />
            <geom type="mesh" mesh="SAKE_Single_Mount"/>
            <geom pos="0.016 0 0" class="ezgripper_viz" mesh="SAKE_Palm_IM"/>
            <geom pos="0.016 0 0" type="mesh" mesh="SAKE_Palm_IM"/>
            <geom name="palm_pulley_f1" type="cylinder" size=".006 0.006" pos="0.0755 0.010 0" class="ezgripper_mech"/>
            <geom name="palm_pulley_f2" type="cylinder" size=".006 0.006" pos="0.0755 -.010 0" class="ezgripper_mech"/>
            <site name="palm_peg0" pos=".022 0 0" size=".002"/>
            <site name="palm_peg1" pos=".063 0 0" size=".002"/>
            <site name="palm_peg2" pos=".085 0 0" size=".002"/>

            <!-- FINGER1 -->
            <body name="F1_L1" pos="0.0755 0.03 0" quat="0.707105 -0.707108 0 0">
                <joint name="F1_palm_knuckle" pos="0 0 0" axis="0 1 0" range="-1.047 0.27" stiffness="0.05114105365" damping="0.05" springref="-0.785"/>
                <geom class="ezgripper_viz" mesh="SAKE_Finger_L1_IM" rgba="1 1 1 1"/>
                <geom name="f1l1" type="mesh" mesh="SAKE_Finger_L1_IM" margin="0.00005" solref="0.0005 1" solimp="0.99 0.99 0.01"/>
                <site name="f1l1_torque" pos="0.04 0.02 0" size=".002"/>
                <geom name="f1_l1_contact" type="box" size="0.005 0.005 0.005" pos="0.035 0 0" rgba="1 0 0 0.6" contype="2" conaffinity="2" group="2"/>
                <geom name="f1l1_pulley" type="cylinder" size=".006 0.006" pos="0.022 0 -.002" class="ezgripper_mech" euler="1.57 0 0"/>
                <site name="f1l1_pulleyside" pos=".022 0 .007" size=".002"/>
                <site name="f1l1_peg0" pos=".0115 0 -.007" size=".002"/>
                <site name="f1l1_peg1" pos=".0355 0 -.006" size=".002"/>

                <body name="F1_L2" pos="0.052 0 0">
                    <joint name="F1_knuckle_tip" pos="0 0 0" axis="0 1 0" range="0 1.7" stiffness="0.02459949416" damping="0.05" springref="1.57"/>
                    <geom pos="0 0 0" class="ezgripper_viz" mesh="SAKE_Finger_L2_IM" rgba="1 1 1 1"/>
                    <geom pos="0 0 0" type="mesh" mesh="SAKE_Finger_L2_IM" margin="0.00005" solref="0.0005 1" solimp="0.99 0.99 0.01"/>
                    <geom pos="0.01849 0 0" quat="0.993291 0 -0.115641 0" class="ezgripper_viz" mesh="SAKE_Finger_Pad_IM" rgba=".2 .2 .2 1"/>
                    <geom name="f1_tip" pos="0.01849 0 0" quat="0.993291 0 -0.115641 0" type="mesh" mesh="SAKE_Finger_Pad_IM" rgba=".2 .2 .2 1" margin="0.00005" solref="0.0005 1" solimp="0.99 0.99 0.01"/>
                    <site name="f1l2_torque" pos="0.03 0.02 0" size=".002"/>
                    <geom name="f1_l2_contact" type="box" size="0.005 0.005 0.005" pos="0.012 0 0" rgba="1 0 0 0.6" contype="3" conaffinity="3" group="2"/>
                    <geom name="f1l2_pulley" type="cylinder" size=".006 0.006" class="ezgripper_mech" euler="1.57 0 0"/>
                    <site name="f1l2_peg" pos=".011 0 -.004" size=".002"/>
                    <site name="f1l2_pin" pos=".0185 0 0" size=".002"/>
                </body>
            </body>

            <!-- FINGER2 -->
            <body name="F2_L1" pos="0.0755 -0.03 0" quat="0.707105 0.707108 0 0">
                <joint name="F2_palm_knuckle" pos="0 0 0" axis="0 1 0" range="-1.047 0.27" stiffness="0.05114105365" damping="0.05" springref="-0.785"/>
                <geom class="ezgripper_viz" mesh="SAKE_Finger_L1_IM" rgba="1 1 1 1"/>
                <geom name="f2l1" type="mesh" mesh="SAKE_Finger_L1_IM" margin="0.00005" solref="0.0005 1" solimp="0.99 0.99 0.01"/>
                <site name="f2l1_torque" pos="0.04 0.02 0" size=".002"/>
                <geom name="f2_l1_contact" type="box" size="0.005 0.005 0.005" pos="0.035 0 0" rgba="1 0 0 0.6" contype="2" conaffinity="2" group="2"/>
                <geom name="f2l1_pulley"  type="cylinder" size=".006 0.006" pos="0.022 0 -.002" class="ezgripper_mech" euler="1.57 0 0"/>
                <site name="f2l1_pulleyside" pos=".022 0 .007" size=".002"/>
                <site name="f2l1_peg0" pos=".0115 0 -.007" size=".002"/>
                <site name="f2l1_peg1" pos=".0355 0 -.006" size=".002"/>

                <body name="F2_L2" pos="0.052 0 0">
                    <joint name="F2_knuckle_tip" pos="0 0 0" axis="0 1 0" range="0 1.7" stiffness="0.02459949416" damping="0.05" springref="1.57"/>
                    <geom pos="0 0 0" class="ezgripper_viz" mesh="SAKE_Finger_L2_IM" rgba="1 1 1 1"/>
                    <geom pos="0 0 0" type="mesh" mesh="SAKE_Finger_L2_IM" margin="0.00005" solref="0.0005 1" solimp="0.99 0.99 0.01"/>
                    <geom pos="0.01849 0 0" quat="0.993291 0 -0.115641 0" class="ezgripper_viz" mesh="SAKE_Finger_Pad_IM" rgba=".2 .2 .2 1"/>
                    <geom name="f2_tip" pos="0.01849 0 0" quat="0.993291 0 -0.115641 0" type="mesh" mesh="SAKE_Finger_Pad_IM" rgba=".2 .2 .2 1" margin="0.00005" solref="0.0005 1" solimp="0.99 0.99 0.01"/>
                    <site name="f2l2_torque" pos="0.03 0.02 0" size=".002"/>
                    <geom name="f2_l2_contact" type="box" size="0.005 0.005 0.005" pos="0.012 0 0" rgba="1 0 0 0.6" contype="3" conaffinity="3" group="2"/>
                    <geom name="f2l2_pulley" type="cylinder" size=".006 0.006" class="ezgripper_mech" euler="1.57 0 0"/>
                    <site name="f2l2_peg" pos=".011 0 -.004" size=".002"/>
                    <site name="f2l2_pin" pos=".0185 0 0" size=".002"/>
                </body>
            </body>
        </body>

    </worldbody>

    <tendon>
        <!-- Primary tendon affecting L1-L2 joint first -->
        <spatial name="tip_tendon" limited="false" range="0.13 0.17">
            <site site="palm_peg1"/>
            <site site="f1l2_torque"/>
        </spatial>

        <!-- Secondary tendon affecting palm joint when tip is constrained -->
        <spatial name="palm_tendon" limited="false" range="0.13 0.17">
            <site site="palm_peg1"/>
            <site site="f1l1_torque"/>
        </spatial>
    </tendon>

    <actuator>
        <motor name="gripper_actuator" tendon="tip_tendon" gear="200" ctrllimited="true" ctrlrange="-1 0"/>
    </actuator>

    <keyframe>
        <key name="open" qpos="-0.52 0.0 -0.52 0.0"/>
    </keyframe>

</mujoco>
